import { addPublicationJsonLd } from '@starter-kit/utils/seo/addPublicationJsonLd';
import { getAutogeneratedPublicationOG } from '@starter-kit/utils/social/og';
import { GetStaticProps } from 'next';
import dynamic from 'next/dynamic';
import Link from 'next/link';
import { useEffect, useState } from 'react';
import { AppProvider } from '../components/contexts/appContext';
import Chatbot from '../components/features/chatbot/Chatbot';
import { ArticleSVG } from '../components/icons';
import { Container } from '../components/shared/container';

import { Layout } from '../components/shared/layout';
import { SEOHead } from '../components/shared/seo-head';

import FeaturedPost from '../components/features/blog/featured-post';
import ModernPostCard from '../components/features/blog/modern-post-card';
import ModernHero from '../components/features/homepage/modern-hero';
import ModernHeader from '../components/features/navigation/modern-header';
import NewsletterCTA from '../components/features/newsletter/newsletter-cta';
import { BlueskySVG, FacebookSVG, GithubSVG, LinkedinSVG, RssSVG } from '../components/icons';

import { PageInfo, PostFragment, PublicationFragment } from '../generated/graphql';
import { generateWebSiteStructuredData } from '../lib/structured-data';
import { DEFAULT_COVER } from '../utils/const';

const SubscribeForm = dynamic(() =>
	import('../components/features/newsletter/subscribe-form').then((mod) => mod.SubscribeForm),
);

const GQL_ENDPOINT = process.env.NEXT_PUBLIC_HASHNODE_GQL_ENDPOINT || 'https://gql.hashnode.com/';

// Type definitions for analytics events
interface PostClickEvent extends CustomEvent {
	detail: {
		slug: string;
		title: string;
	};
}

interface SocialClickEvent extends CustomEvent {
	detail: {
		platform: string;
	};
}

interface NewsletterSubscriptionEvent extends CustomEvent {
	detail: {
		status: string;
	};
}

type Props = {
	publication: PublicationFragment;
	initialAllPosts: PostFragment[];
	initialPageInfo: PageInfo;
	initialTotalPosts: number;
};

export default function Blog({
	publication,
	initialAllPosts,
	initialPageInfo,
	initialTotalPosts,
}: Props) {
	const [allPosts] = useState<PostFragment[]>(initialAllPosts);
	const [visibleSections, setVisibleSections] = useState<Set<string>>(new Set());

	// Intersection Observer for scroll animations
	// This creates a smooth fade-in effect for sections as they come into view
	useEffect(() => {
		const observer = new IntersectionObserver(
			(entries) => {
				// Track which sections are currently visible for animation triggers
				entries.forEach((entry) => {
					if (entry.isIntersecting) {
						setVisibleSections((prev) => new Set([...prev, entry.target.id]));
					}
				});
			},
			{
				threshold: 0.1, // Trigger when 10% of element is visible
				rootMargin: '0px 0px -50px 0px', // Start animation 50px before element enters viewport
			},
		);

		// Observe all sections with data-animate-section attribute
		const sections = document.querySelectorAll('[data-animate-section]');
		sections.forEach((section) => {
			observer.observe(section);
		});

		// Cleanup: unobserve all sections when component unmounts
		return () => {
			sections.forEach((section) => {
				observer.unobserve(section);
			});
		};
	}, []);


	// Analytics tracking with centralized utilities and enhanced error handling
	useEffect(() => {
		let analyticsUtils: any = null;

		// Initialize analytics utilities
		const initAnalytics = async () => {
			try {
				analyticsUtils = await import('../lib/analytics-utils');
			} catch (error) {
				console.warn('Failed to load analytics utilities:', error);
			}
		};

		// Track page view with enhanced error handling
		const trackPageView = async () => {
			try {
				if (analyticsUtils) {
					await analyticsUtils.trackPageView(
						`Blog - ${publication.displayTitle || publication.title || 'John Schibelli'}`,
						window.location.href
					);
				}
			} catch (error) {
				console.warn('Failed to track page view:', error);
			}
		};

		// Track newsletter subscription events with centralized utility
		const handleNewsletterSubscription = async (event: NewsletterSubscriptionEvent) => {
			try {
				if (analyticsUtils && event.detail?.status) {
					await analyticsUtils.trackNewsletterSubscription({
						status: event.detail.status,
						timestamp: new Date().toISOString(),
						publicationId: publication.id
					});
				}
			} catch (error) {
				console.warn('Failed to track newsletter subscription:', error);
			}
		};

		// Track post click events with centralized utility
		const handlePostClick = async (event: PostClickEvent) => {
			try {
				if (analyticsUtils && event.detail?.slug && event.detail?.title) {
					await analyticsUtils.trackPostClick({
						slug: event.detail.slug,
						title: event.detail.title,
						timestamp: new Date().toISOString()
					});
				} else {
					console.warn('Post click event missing required properties:', event.detail);
				}
			} catch (error) {
				console.warn('Failed to track post click:', error);
			}
		};

		// Track social media clicks with validation
		const handleSocialClick = (event: SocialClickEvent) => {
			try {
				if (typeof window !== 'undefined' && window.gtag && event.detail?.platform) {
					window.gtag('event', 'social_click', {
						event_category: 'engagement',
						event_label: event.detail.platform,
						value: 1,
					});
				} else {
					console.warn('Social click event missing platform:', event.detail);
				}
			} catch (error) {
				console.warn('Failed to track social click:', error);
			}
		};

		// Initialize analytics and track page view
		initAnalytics().then(() => {
			trackPageView();
		});

		// Add event listeners
		window.addEventListener('newsletter-subscription', handleNewsletterSubscription as EventListener);
		window.addEventListener('post-click', handlePostClick as EventListener);
		window.addEventListener('social-click', handleSocialClick as EventListener);

		return () => {
			window.removeEventListener('newsletter-subscription', handleNewsletterSubscription as EventListener);
			window.removeEventListener('post-click', handlePostClick as EventListener);
			window.removeEventListener('social-click', handleSocialClick as EventListener);
		};
	}, [publication]);

	// Get additional posts beyond the first 4 (featured + 3 latest)
	const morePosts = allPosts.slice(4);

	// Helper function to check if a section should be visible for animations
	const isSectionVisible = (sectionId: string) => visibleSections.has(sectionId);

	return (
		<AppProvider publication={publication}>
			<Layout>
				<SEOHead
					title={`Blog - ${publication.displayTitle || publication.title || 'John Schibelli'}`}
					description={`Read insights, tutorials, and thoughts on modern web development, React, Next.js, TypeScript, and technology from ${publication.author.name}.`}
					keywords={[
						'Web Development Blog',
						'React Tutorials',
						'Next.js Tips',
						'TypeScript Guides',
						'Front-End Development',
						'Web Performance',
						'SEO Best Practices',
						'Accessibility',
						'Modern Web Technologies',
						'Development Tips',
					]}
					canonical="/blog"
					ogImage={getAutogeneratedPublicationOG(publication)}
					ogType="website"
					structuredData={generateWebSiteStructuredData()}
				/>
				<ModernHeader publication={publication} />

				{/* Modern Hero Section */}
				{allPosts.length > 0 && (
					<div
						id="hero-section"
						data-animate-section
						className={`transition-all duration-1000 ease-out ${
							isSectionVisible('hero-section')
								? 'translate-y-0 opacity-100'
								: 'translate-y-8 opacity-0'
						}`}
					>
						<ModernHero
							title="The Developer's Lens"
							subtitle="Technology & Development"
							description="Unfiltered perspectives on code, creativity, and the constant evolution of technology."
							imageUrl="/assets/hero/hero-image.webp"
						/>
					</div>
				)}

				{/* Social Media Icons - Right under the hero */}
				<div className="bg-white py-8 dark:bg-stone-950">
					<Container className="px-5">
						<div className="flex justify-center">
							<div className="flex items-center gap-4">
								{/* Facebook */}
								<a
									href="https://facebook.com"
									target="_blank"
									rel="noopener noreferrer"
									aria-label="Find us on Facebook, external website, opens in new tab"
									className="flex items-center justify-center rounded-full border border-stone-200 p-3 text-stone-700 transition-colors hover:bg-stone-100 hover:text-stone-900 dark:border-stone-700 dark:text-stone-300 dark:hover:bg-stone-800 dark:hover:text-stone-100"
									onClick={() => {
										// Track social media click with error handling
										try {
											if (typeof window !== 'undefined') {
												window.dispatchEvent(new CustomEvent('social-click', {
													detail: { platform: 'facebook' }
												}));
											}
										} catch (error) {
											console.warn('Failed to dispatch social click event:', error);
										}
									}}
								>
									<FacebookSVG className="h-5 w-5" />
								</a>

								{/* GitHub */}
								<a
									href="https://github.com"
									target="_blank"
									rel="noopener noreferrer"
									aria-label="Find us on Github, external website, opens in new tab"
									className="flex items-center justify-center rounded-full border border-stone-200 p-3 text-stone-700 transition-colors hover:bg-stone-100 hover:text-stone-900 dark:border-stone-700 dark:text-stone-300 dark:hover:bg-stone-800 dark:hover:text-stone-100"
									onClick={() => {
										// Track social media click with error handling
										try {
											if (typeof window !== 'undefined') {
												window.dispatchEvent(new CustomEvent('social-click', {
													detail: { platform: 'github' }
												}));
											}
										} catch (error) {
											console.warn('Failed to dispatch social click event:', error);
										}
									}}
								>
									<GithubSVG className="h-5 w-5 stroke-current" />
								</a>

								{/* LinkedIn */}
								<a
									href="https://linkedin.com"
									target="_blank"
									rel="noopener noreferrer"
									aria-label="Find us on Linkedin, external website, opens in new tab"
									className="flex items-center justify-center rounded-full border border-stone-200 p-3 text-stone-700 transition-colors hover:bg-stone-100 hover:text-stone-900 dark:border-stone-700 dark:text-stone-300 dark:hover:bg-stone-800 dark:hover:text-stone-100"
									onClick={() => {
										// Track social media click with error handling
										try {
											if (typeof window !== 'undefined') {
												window.dispatchEvent(new CustomEvent('social-click', {
													detail: { platform: 'linkedin' }
												}));
											}
										} catch (error) {
											console.warn('Failed to dispatch social click event:', error);
										}
									}}
								>
									<LinkedinSVG className="h-5 w-5 stroke-current" />
								</a>

								{/* Bluesky */}
								<a
									href="https://bsky.app"
									target="_blank"
									rel="noopener noreferrer"
									aria-label="Find us on Bluesky, external website, opens in new tab"
									className="flex items-center justify-center rounded-full border border-stone-200 p-3 text-stone-700 transition-colors hover:bg-stone-100 hover:text-stone-900 dark:border-stone-700 dark:text-stone-300 dark:hover:bg-stone-800 dark:hover:text-stone-100"
									onClick={() => {
										// Track social media click with error handling
										try {
											if (typeof window !== 'undefined') {
												window.dispatchEvent(new CustomEvent('social-click', {
													detail: { platform: 'bluesky' }
												}));
											}
										} catch (error) {
											console.warn('Failed to dispatch social click event:', error);
										}
									}}
								>
									<BlueskySVG className="h-5 w-5 stroke-current" />
								</a>

								{/* RSS Feed */}
								<Link
									prefetch={false}
									href={`/rss.xml`}
									target="_blank"
									rel="noopener noreferrer"
									aria-label="Open blog XML Feed, opens in new tab"
									className="flex items-center justify-center rounded-full border border-stone-200 p-3 text-stone-700 transition-colors hover:bg-stone-100 hover:text-stone-900 dark:border-stone-700 dark:text-stone-300 dark:hover:bg-stone-800 dark:hover:text-stone-100"
									onClick={() => {
										// Track social media click with error handling
										try {
											if (typeof window !== 'undefined') {
												window.dispatchEvent(new CustomEvent('social-click', {
													detail: { platform: 'rss' }
												}));
											}
										} catch (error) {
											console.warn('Failed to dispatch social click event:', error);
										}
									}}
								>
									<RssSVG className="h-5 w-5 stroke-current" />
								</Link>
							</div>
						</div>
					</Container>
				</div>

				<Container className="flex flex-col items-stretch gap-10 px-5 pb-10">
					{/* Empty State */}
					{allPosts.length === 0 && (
						<div
							id="empty-state-section"
							data-animate-section
							className={`duration-800 grid grid-cols-1 py-20 transition-all ease-out lg:grid-cols-3 ${
								isSectionVisible('empty-state-section')
									? 'translate-y-0 opacity-100'
									: 'translate-y-8 opacity-0'
							}`}
						>
							<div className="col-span-1 flex flex-col items-center gap-5 text-center text-stone-700 lg:col-start-2 dark:text-stone-400">
								<div className="animate-fade-in-up w-20">
									<ArticleSVG className="stroke-current" />
								</div>
								<p className="animate-fade-in-up animation-delay-200 text-xl font-semibold">
									Hang tight! We&apos;re drafting the first article.
								</p>
							</div>
						</div>
					)}

					{/* Featured Post Section */}
					{allPosts.length > 0 && (
						<div
							id="featured-section"
							data-animate-section
							className={`duration-900 space-y-12 transition-all ease-out ${
								isSectionVisible('featured-section')
									? 'translate-y-0 opacity-100'
									: 'translate-y-8 opacity-0'
							}`}
						>
							<FeaturedPost
								post={allPosts[0]}
								coverImage={allPosts[0].coverImage?.url || DEFAULT_COVER}
								readTime="5 min read"
								tags={['Featured', 'Technology', 'Insights']}
							/>

							{/* Latest Posts Grid - Shows 3 most recent posts after featured */}
							{allPosts.length > 1 && (
								<div
									id="latest-posts-section"
									data-animate-section
									className={`space-y-6 transition-all duration-1000 ease-out ${
										isSectionVisible('latest-posts-section')
											? 'translate-y-0 opacity-100'
											: 'translate-y-8 opacity-0'
									}`}
								>
									<h2 className="animate-fade-in-up text-2xl font-bold text-stone-900 dark:text-stone-100">
										Latest Posts
									</h2>
									{/* Responsive grid: 1 column on mobile, 2 on tablet, 3 on desktop */}
									<div className="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
										{/* Render posts 2-4 (skip first post as it's featured above) */}
										{allPosts.slice(1, 4).map((post, index) => (
											<div
												key={post.id}
												className={`animate-fade-in-up transition-all duration-300 hover:scale-[1.02] ${
													index === 0
														? 'animation-delay-200'
														: index === 1
															? 'animation-delay-300'
															: 'animation-delay-400'
												}`}
											>
												<ModernPostCard
													title={post.title}
													excerpt={post.brief}
													coverImage={post.coverImage?.url || DEFAULT_COVER}
													date={post.publishedAt}
													slug={post.slug}
													readTime="3 min read"
													tags={['Technology', 'Development']}
												/>
											</div>
										))}
									</div>
								</div>
							)}
						</div>
					)}

					{/* Newsletter CTA Section */}
					{allPosts.length > 0 && (
						<div
							id="newsletter-section"
							data-animate-section
							className={`duration-1100 py-8 transition-all ease-out ${
								isSectionVisible('newsletter-section')
									? 'translate-y-0 opacity-100'
									: 'translate-y-8 opacity-0'
							}`}
						>
							<NewsletterCTA
								title="Stay updated with our newsletter"
								showNewsletterForm={true}
								className="py-16"
							/>
						</div>
					)}
				</Container>
				<Chatbot />
			</Layout>
		</AppProvider>
	);
}

export const getStaticProps: GetStaticProps<Props> = async () => {
	const host = process.env.NEXT_PUBLIC_HASHNODE_PUBLICATION_HOST || 'mindware.hashnode.dev';

	try {
		// Use a direct fetch instead of graphql-request to avoid the document issue
		const response = await fetch(GQL_ENDPOINT, {
			method: 'POST',
			headers: {
				'Content-Type': 'application/json',
			},
			body: JSON.stringify({
				query: `
					query PostsByPublication($host: String!, $first: Int!, $after: String) {
						publication(host: $host) {
							id
							title
							displayTitle
							url
							descriptionSEO
							author {
								name
								profilePicture
							}
							posts(first: $first, after: $after) {
								totalDocuments
								edges {
									node {
										id
										title
										brief
										slug
										publishedAt
										coverImage {
											url
										}
										author {
											name
											profilePicture
										}
									}
								}
								pageInfo {
									endCursor
									hasNextPage
								}
							}
							preferences {
								logo
							}
							followersCount
							isTeam
							favicon
							ogMetaData {
								image
							}
						}
					}
				`,
				variables: {
					host: host,
					first: 10,
				},
			}),
		});

		const data = await response.json();
		const publication = data.data?.publication;

		if (!publication) {
			return {
				notFound: true,
			};
		}

		const initialAllPosts = publication.posts.edges.map((edge: any) => edge.node);

		return {
			props: {
				publication,
				initialAllPosts,
				initialPageInfo: publication.posts.pageInfo,
				initialTotalPosts: publication.posts.totalDocuments,
			},
			revalidate: 1,
		};
	} catch (error) {
		console.error('Error fetching blog data:', error);
		// Return a fallback response to prevent the build from failing
		return {
			props: {
				publication: {
					id: '67a1884c4dc993328a8c454c',
					title: 'John Schibelli',
					displayTitle: 'John Schibelli',
					descriptionSEO: 'Senior Front-End Developer with 15+ years of experience',
					url: 'https://mindware.hashnode.dev',
					posts: {
						edges: [],
						pageInfo: {
							hasNextPage: false,
							endCursor: null,
						},
						totalDocuments: 0,
					},
					preferences: {
						logo: null,
					},
					author: {
						name: 'John Schibelli',
						profilePicture: null,
					},
					followersCount: 0,
					isTeam: false,
					favicon: null,
					ogMetaData: {
						image: null,
					},
				} as any,
				initialAllPosts: [],
				initialPageInfo: {
					hasNextPage: false,
					endCursor: null,
				},
				initialTotalPosts: 0,
			},
			revalidate: 1,
		};
	}
};
